name: Build with Cmake & MSVC
run-name: building & testing with Cmake & MSVC
on:
  push:
    branches:
      - 'build-msvc/**'
      - 'build/**'
jobs:
  Build-with-cmake-msvc:
    runs-on: windows-latest
    timeout-minutes: 40
    steps:
      - run: echo "The job was automatically triggered by a ${{ github.event_name }} event."
      - run: echo "This job is now running on a ${{ runner.os }} server hosted by GitHub."
      - run: echo "Branch [ ${{ github.ref }} ]  Repository [ ${{ github.repository }} ]"
      - name: Check out repository code
        uses: actions/checkout@v4
      - name: cmake
        shell: pwsh
        run: |
          New-Item .\Work -ItemType Directory
          cd .\Work
          cmake.exe ..
      - name: cmake --build
        shell: pwsh
        run: |
          cd .\Work
          cmake.exe --build .

      - name: test kpathsea
        shell: bash
        run: |
          cd ./Work
          export BinDir=./Debug/bin ExeExt=.exe srcdir=../source/texk/kpathsea
          $srcdir/tests/cnfline.test
          $srcdir/tests/cnfnewline.test
          $srcdir/tests/cnfnull.test || echo "**\n** failed: cnfnull.test\n**"
          $srcdir/tests/cnfprog.test
          # $srcdir/tests/kpseaccess.test
          # $srcdir/tests/kpsereadlink.test
          $srcdir/tests/kpsestat.test
          $srcdir/tests/kpsewhich.test
        env:
          srcroot: "../source"
          TEXMFCNF: "../source/texk/kpathsea/tests/windows"

      - name: test dvipdfm-x
        shell: bash
        run: |
          cd ./Work
          export BinDir=./Debug/bin ExeExt=.exe srcdir=../source/texk/dvipdfm-x
          $srcdir/xdvipdfmx.test
          $srcdir/xdvipdfm-ann.test
          $srcdir/xdvipdfm-bad.test
          $srcdir/xdvipdfm-bb.test
          $srcdir/xdvipdfm-bkm.test
          $srcdir/xdvipdfm-psz.test
          $srcdir/xdvipdfm-ptx.test
          $srcdir/xdvipdfm-res.test
          $srcdir/xdvipdfm-rev.test
          $srcdir/xdvipdfm-ttc.test
          $srcdir/dvipdfmx-upjf.test
        env:
          srcroot: "../source"
          TEXMFCNF: "../source/texk/kpathsea/tests/windows"
          SOURCE_DATE_EPOCH: "1588474800"

      - name: test dvips
        shell: bash
        run: |
          cd ./Work
          export BinDir=./Debug/bin ExeExt=.exe srcdir=../source/texk/dvipsk
          $srcdir/test-dvips.test
          $srcdir/test-afm2tfm.test
          $srcdir/beginfontk1.test
          $srcdir/eepic-nan.test
          $srcdir/pfbincl.test
          $srcdir/quotecmd-test.pl || echo "quotecmd-test.pl"
          $srcdir/same-name.test
          $srcdir/test-missing-image.test
          $srcdir/test-overflow-buffers.test
          $srcdir/uptex-vf.test
        env:
          srcroot: "../source"
          TEXMFCNF: "../source/texk/kpathsea/tests/windows"
          SOURCE_DATE_EPOCH: "1588474800"

      - name: test makejvf
        shell: bash
        run: |
          cd ./Work
          export BinDir=./Debug/bin ExeExt=.exe srcdir=../source/texk/makejvf
          $srcdir/makejvf.test
        env:
          srcroot: "../source"
          TEXMFCNF: "../source/texk/kpathsea/tests/windows"

      - name: test mendex
        shell: bash
        run: |
          cd ./Work
          export BinDir=./Debug/bin ExeExt=.exe srcdir=../source/texk/mendexk
          $srcdir/tests/mendex.test
        env:
          srcroot: "../source"
          TEXMFCNF: "../source/texk/kpathsea/tests/windows"

      - name: test upmendex
        shell: bash
        run: |
          cd ./Work
          export BinDir=./Debug/bin ExeExt=.exe srcdir=../source/texk/upmendex
          $srcdir/tests/upmendex.test
        env:
          srcroot: "../source"
          TEXMFCNF: "../source/texk/kpathsea/tests/windows"

      - name: test bibtex-x
        shell: bash
        run: |
          cd ./Work
          export BinDir=./Debug/bin ExeExt=.exe srcdir=../source/texk/bibtex-x
          $srcdir/tests/bibtex8.test
          $srcdir/tests/bibtexu.test
          $srcdir/tests/bibtex8u-mem.test
          $srcdir/tests/bibtex8-char.test
          $srcdir/tests/bibtex8-sort.test
          $srcdir/tests/bibtexu-basic.test
          $srcdir/tests/bibtexu-range.test
          $srcdir/tests/bibtexu-char.test || \
            { if [ "$?" = "77" ]; then r="SKIP" ; else r="FAIL" ; fi } && echo "$r: bibtexu-char.test"
          $srcdir/tests/bibtexu-iscjk.test
          $srcdir/tests/bibtexu-sort.test
          $srcdir/tests/bibtexu-yannis.test
        env:
          srcroot: "../source"
          TEXMFCNF: "../source/texk/kpathsea/tests/windows"

      - name: test dviout-util
        shell: bash
        run: |
          cd ./Work
          export BinDir=./Debug/bin ExeExt=.exe srcdir=../source/texk/dviout-util
          $srcdir/dvispc.test
          $srcdir/chkdvifont.test
        env:
          srcroot: "../source"
          TEXMFCNF: "../source/texk/kpathsea/tests/windows"

      - name: test dvi2tty
        shell: bash
        run: |
          cd ./Work
          export BinDir=./Debug/bin ExeExt=.exe srcdir=../source/texk/dvi2tty DVI2TTY_TREE=dvi2tty-src
          $srcdir/disdvi.test
          $srcdir/dvi2tty.test
        env:
          srcroot: "../source"
          TEXMFCNF: "../source/texk/kpathsea/tests/windows"

      - name: test seetex
        shell: bash
        run: |
          cd ./Work
          export BinDir=./Debug/bin ExeExt=.exe srcdir=../source/texk/seetexk
          $srcdir/seetexk.test
        env:
          srcroot: "../source"
          TEXMFCNF: "../source/texk/kpathsea/tests/windows"

      - name: test dvidvi
        shell: bash
        run: |
          cd ./Work
          export BinDir=./Debug/bin ExeExt=.exe srcdir=../source/texk/dvidvi
          $srcdir/dvidvi.test
        env:
          srcroot: "../source"
          TEXMFCNF: "../source/texk/kpathsea/tests/windows"

      - name: web2c version check
        shell: bash
        run: |
          cd ./Work/Debug/bin
          ./tie.exe --version || echo "tie"
          echo ""
          ./tangleboot.exe --version || echo "tangleboot"
          echo ""
          ./tangle.exe --version || echo "tangle"
          echo ""
          ./ctangle.exe --version || echo "ctangle"
          echo ""
          ./uptex.exe --version || echo "uptex"
          echo ""
          ls -lR
          echo ""
          ./euptex.exe --version || echo "euptex"
          #echo ""
          #./updvitype.exe --version || echo "updvitype"
          #echo ""
          #./uppltotf.exe --version || echo "uppltotf"
          #echo ""
          #./uptftopl.exe --version || echo "uptftopl"
          #echo ""
          #./upbibtex.exe --version || echo "upbibtex"

        env:
          srcroot: "../source"
          TEXMFCNF: "../source/texk/kpathsea/tests/windows"

      - name: test web2c
        shell: bash
        run: |
          cd ./Work
          export BinDir=./Debug/bin ExeExt=.exe KpsDir=./Debug/bin srcdir=../source/texk/web2c
          # $srcdir/ctiedir/ctie.test   || echo -e "**\n** failed: ctie.test\n**"
          # $srcdir/cwebdir/ctwill.test || echo -e "**\n** failed: ctwill.test\n**"
          # $srcdir/cwebdir/cweave.test || echo -e "**\n** failed: cweave.test\n**"
          $srcdir/tiedir/tie.test       || echo -e "**\n** failed: tie.test\n**"
          $srcdir/tangle.test           || echo -e "**\n** failed: tangle.test\n**"

          $srcdir/dvicopy.test          || echo -e "**\n** failed: dvicopy.test\n**"
          $srcdir/dvitype.test          || echo -e "**\n** failed: dvitype.test\n**"
          $srcdir/gftodvi.test          || echo -e "**\n** failed: gftodvi.test\n**"
          $srcdir/gftopk.test           || echo -e "**\n** failed: gftopk.test\n**"
          $srcdir/gftype.test           || echo -e "**\n** failed: gftype.test\n**"
          $srcdir/mft.test              || echo -e "**\n** failed: mft.test\n**"
          $srcdir/patgen.test           || echo -e "**\n** failed: patgen.test\n**"
          $srcdir/pktogf.test           || echo -e "**\n** failed: pktogf.test\n**"
          $srcdir/pktype.test           || echo -e "**\n** failed: pktype.test\n**"
          $srcdir/pltotf.test           || echo -e "**\n** failed: pltotf.test\n**"
          $srcdir/pooltype.test         || echo -e "**\n** failed: pooltype.test\n**"
          $srcdir/tftopl.test           || echo -e "**\n** failed: tftopl.test\n**"
          $srcdir/vftovp.test           || echo -e "**\n** failed: vftovp.test\n**"
          $srcdir/vptovf.test           || echo -e "**\n** failed: vptovf.test\n**"
          $srcdir/weave.test            || echo -e "**\n** failed: weave.test\n**"

        env:
          srcroot: "../source"
          TEXMFCNF: "../source/texk/kpathsea/tests/windows"

      - name: test web2c/*ptex
        shell: bash
        run: |
          cd ./Work
          export BinDir=./Debug/bin ExeExt=.exe KpsDir=./Debug/bin W2CDir=../Debug/bin srcdir=../source/texk/web2c abs_srcdir=../../source/texk/web2c
          $srcdir/uptexdir/uptriptest.test || echo -e "**\n** failed: up/uptriptest.test\n**"
          $srcdir/uptexdir/ptriptest.test  || echo -e "**\n** failed: up/ptriptest.test\n**"
          $srcdir/uptexdir/upver.test      || echo -e "**\n** failed: up/upver.test\n**"
          $srcdir/uptexdir/upkcat.test     || echo -e "**\n** failed: up/upkcat.test\n**"
          $srcdir/uptexdir/wcfname.test    || echo -e "**\n** failed: up/wcfname.test\n**"
          $srcdir/uptexdir/wcfname0.test   || echo -e "**\n** failed: up/wcfname0.test\n**"

          $srcdir/euptexdir/euptriptest.test  || echo -e "**\n** failed: eup/euptriptest.test\n**"
          $srcdir/euptexdir/eptriptest.test   || echo -e "**\n** failed: eup/eptriptest.test\n**"
          $srcdir/euptexdir/pdfprimitive.test || echo -e "**\n** failed: eup/pdfprimitive.test\n**"
          $srcdir/euptexdir/eupver.test       || echo -e "**\n** failed: eup/eupver.test\n**"
          $srcdir/euptexdir/wcfname.test      || echo -e "**\n** failed: eup/wcfname.test\n**"
          $srcdir/euptexdir/wcfname0.test     || echo -e "**\n** failed: eup/wcfname0.test\n**"

        env:
          srcroot: "../source"
          TEXMFCNF: "../source/texk/kpathsea/tests/windows"
          LN_S: "cp"

      - name: web2c version check
        shell: bash
        run: |
          cd ./Work/Debug/bin
          # ./ctie.exe --version || echo "ctie"
          # echo ""
          # ./ctwill.exe --version || echo "ctwill"
          # echo ""
          # ./cweave.exe --version || echo "cwaeve"
          # echo ""
          ./tie.exe --version || echo "tie"
          echo ""
          # ./twill.exe --version || echo "twill"
          # echo ""
          # ./tex.exe --version || echo "tex"
          # echo ""
          # ./etex.exe --version || echo "etex"
          # echo ""
          ./uptex.exe --version || echo "uptex"
          echo ""
          ./euptex.exe --version || echo "euptex"
          echo ""
          # ./updvitype.exe --version || echo "updvitype"
          # echo ""
          # ./uppltotf.exe --version || echo "uppltotf"
          # echo ""
          # ./uptftopl.exe --version || echo "uptftopl"
          # echo ""
          # ./upbibtex.exe --version || echo "upbibtex"
          # echo ""
          ./dvitype.exe --version || echo "dvitype"
          echo ""
          ./dvicopy.exe --version || echo "dvicopy"
          echo ""
          ./pltotf.exe --version || echo "pltotf"
          echo ""
          ./tftopl.exe --version || echo "tftopl"
          echo ""
          # ./bibtex.exe --version || echo "bibtex"
          # echo ""
          ./gftodvi.exe --version || echo "gftodvi"
          echo ""
          ./gftopk.exe --version || echo "gftopk"
          echo ""
          ./gftype.exe --version || echo "gftype"
          echo ""
          ./mft.exe --version || echo "mft"
          echo ""
          ./patgen.exe --version || echo "patgen"
          echo ""
          ./pktogf.exe --version || echo "pktogf"
          echo ""
          ./pktype.exe --version || echo "pktype"
          echo ""
          ./pooltype.exe --version || echo "pooltype"
          echo ""
          ./vftovp.exe --version || echo "vftovp"
          echo ""
          ./vptovf.exe --version || echo "vptovf"
          echo ""
          ./weave.exe --version || echo "weave"
          echo ""
          # ./mpost.exe --version || echo "mpost"
          # echo ""
          # ./pmpost.exe --version || echo "pmpost"
          # echo ""
          # ./upmpost.exe --version || echo "upmpost"
          # echo ""
          # ./synctex.exe help || echo "synctex"
        env:
          TEXMFCNF: "../../../source/texk/kpathsea/tests/windows"

      - name: test web2c/omegafonts
        shell: bash
        run: |
          cd ./Work
          export BinDir=./Debug/bin ExeExt=.exe W2CDir=./Debug/bin srcdir=../source/texk/web2c/omegafonts
          $srcdir/bad.test         || echo -e "**\n** failed: omegafonts/bad.test\n**"
          $srcdir/charwd.test      || echo -e "**\n** failed: omegafonts/charwd.test\n**"
          $srcdir/check.test       || echo -e "**\n** failed: omegafonts/check.test\n**"
          $srcdir/help.test        || echo -e "**\n** failed: omegafonts/help.test\n**"
          $srcdir/level1.test      || echo -e "**\n** failed: omegafonts/level1.test\n**"
          $srcdir/ligkern.test     || echo -e "**\n** failed: omegafonts/ligkern.test\n**"
          $srcdir/ofonts.test      || echo -e "**\n** failed: omegafonts/ofonts.test\n**"
          $srcdir/omfonts.test     || echo -e "**\n** failed: omegafonts/omfonts.test\n**"
          $srcdir/overbmp.test     || echo -e "**\n** failed: omegafonts/overbmp.test\n**"
          $srcdir/realnum.test     || echo -e "**\n** failed: omegafonts/realnum.test\n**"
          $srcdir/repeat.test      || echo -e "**\n** failed: omegafonts/repeat.test\n**"
          $srcdir/selectfont.test  || echo -e "**\n** failed: omegafonts/selectfont.test\n**"
          $srcdir/shorten.test     || echo -e "**\n** failed: omegafonts/shorten.test\n**"
          $srcdir/specialhex.test  || echo -e "**\n** failed: omegafonts/specialhex.test\n**"
          $srcdir/version.test     || echo -e "**\n** failed: omegafonts/version.test\n**"
          $srcdir/yannis.test      || echo -e "**\n** failed: omegafonts/yannis.test\n**"

        env:
          TEXMFCNF: "../source/texk/kpathsea/tests/windows"

      - run: echo "⛄ This job's status is ${{ job.status }}."
